# EstratÃ©gia Multicanal - TÃ¡ na MÃ£o

## VisÃ£o Geral

O TÃ¡ na MÃ£o adota uma estratÃ©gia multicanal para maximizar o alcance e acessibilidade do serviÃ§o. Com aproximadamente 40-50% de penetraÃ§Ã£o de smartphones em famÃ­lias de extrema pobreza, Ã© fundamental oferecer mÃºltiplos canais de acesso.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   CAMADA DE CANAIS                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ WhatsApp â”‚  â”‚   SMS    â”‚  â”‚  Voice   â”‚  â”‚   Web    â”‚    â”‚
â”‚  â”‚ Handler  â”‚  â”‚ Handler  â”‚  â”‚ Handler  â”‚  â”‚ Handler  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â”‚
â”‚       â”‚             â”‚             â”‚             â”‚          â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                            â”‚                               â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                    â”‚ Channel       â”‚                       â”‚
â”‚                    â”‚ Normalizer    â”‚                       â”‚
â”‚                    â”‚ (Mensagem     â”‚                       â”‚
â”‚                    â”‚  Unificada)   â”‚                       â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                            â”‚                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚    Agent      â”‚
                     â”‚ Orchestrator  â”‚
                     â”‚  (Existente)  â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Canais Suportados

| Canal | PÃºblico Alvo | Cobertura Estimada | Status |
|-------|--------------|-------------------|--------|
| **WhatsApp** | Smartphones com internet | 60-70% | âœ… Implementado |
| **SMS/USSD** | Feature phones e bÃ¡sicos | +20% | ğŸ”„ Em desenvolvimento |
| **0800 (Voz)** | Telefone fixo/qualquer celular | +10% | ğŸ”„ Em desenvolvimento |
| **Web** | Acesso via navegador | Complementar | âœ… Implementado |
| **LotÃ©ricas** | Presencial (terminais) | Futuro | ğŸ“‹ Planejado |
| **CRAS** | Presencial (tablets) | Futuro | ğŸ“‹ Planejado |

## Canal SMS/USSD

### Arquitetura

O canal SMS funciona como um menu USSD-like, onde o usuÃ¡rio navega por opÃ§Ãµes numÃ©ricas.

```
UsuÃ¡rio envia SMS para nÃºmero curto (ex: 28282)
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ "1" = Consultar benefÃ­cios      â”‚
â”‚ "2" = Dinheiro esquecido        â”‚
â”‚ "3" = FarmÃ¡cia Popular          â”‚
â”‚ "4" = CRAS mais prÃ³ximo         â”‚
â”‚ "5" = Falar com atendente       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
    UsuÃ¡rio responde "1"
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ "Digite seu CPF (sÃ³ nÃºmeros):"  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
    UsuÃ¡rio: "12345678901"
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VocÃª tem 2 benefÃ­cios ativos:   â”‚
â”‚ - Bolsa FamÃ­lia: R$ 600/mÃªs     â”‚
â”‚ - TSEE: Economia R$ 45/mÃªs      â”‚
â”‚                                 â”‚
â”‚ Responda "M" para mais opÃ§Ãµes   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Estados de NavegaÃ§Ã£o SMS

```python
class SMSState(str, Enum):
    """Estados do fluxo SMS."""

    MENU_PRINCIPAL = "menu_principal"
    AGUARDANDO_CPF = "aguardando_cpf"
    AGUARDANDO_CEP = "aguardando_cep"
    RESULTADO = "resultado"
    MENU_SECUNDARIO = "menu_secundario"
```

### Endpoints

| MÃ©todo | Endpoint | DescriÃ§Ã£o |
|--------|----------|-----------|
| POST | `/api/v1/sms/webhook` | Recebe SMS do provedor |
| POST | `/api/v1/sms/status` | Status de entrega |
| GET | `/api/v1/sms/session/{phone}` | Estado da sessÃ£o |

### IntegraÃ§Ã£o com Provedores

```python
# Exemplo de webhook Twilio/Zenvia
{
    "from": "+5511999999999",
    "to": "28282",
    "body": "1",
    "message_id": "SM123...",
    "timestamp": "2025-01-16T10:30:00Z"
}
```

## Canal 0800 (Voz/URA)

### Arquitetura

O canal de voz utiliza URA (IVR) para navegaÃ§Ã£o por DTMF e TTS para respostas.

```
UsuÃ¡rio liga para 0800-XXX-XXXX
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ "Bem-vindo ao TÃ¡ na MÃ£o.        â”‚
â”‚  Para consultar benefÃ­cios,     â”‚
â”‚  digite 1.                      â”‚
â”‚  Para dinheiro esquecido,       â”‚
â”‚  digite 2..."                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
    UsuÃ¡rio digita "2"
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ "Digite seu CPF usando o        â”‚
â”‚  teclado do telefone"           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [TTS do agente]:                â”‚
â”‚ "VocÃª tem R$ 1.200 de PIS       â”‚
â”‚  disponÃ­vel para saque.         â”‚
â”‚  Para instruÃ§Ãµes de como        â”‚
â”‚  sacar, digite 1..."            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Estados de NavegaÃ§Ã£o Voz

```python
class VoiceState(str, Enum):
    """Estados do fluxo de voz."""

    BOAS_VINDAS = "boas_vindas"
    MENU_PRINCIPAL = "menu_principal"
    COLETANDO_CPF = "coletando_cpf"
    PROCESSANDO = "processando"
    RESULTADO = "resultado"
    MENU_OPCOES = "menu_opcoes"
    TRANSFERINDO = "transferindo"
    DESPEDIDA = "despedida"
```

### Endpoints

| MÃ©todo | Endpoint | DescriÃ§Ã£o |
|--------|----------|-----------|
| POST | `/api/v1/voice/webhook` | Recebe chamada (inÃ­cio) |
| POST | `/api/v1/voice/dtmf` | Recebe dÃ­gitos DTMF |
| POST | `/api/v1/voice/status` | Status da chamada |
| GET | `/api/v1/voice/session/{call_id}` | Estado da sessÃ£o |

### TwiML/VXML de Exemplo

```xml
<?xml version="1.0" encoding="UTF-8"?>
<Response>
    <Say voice="Polly.Camila" language="pt-BR">
        Bem-vindo ao TÃ¡ na MÃ£o, seu assistente de benefÃ­cios sociais.
    </Say>
    <Gather numDigits="1" action="/api/v1/voice/dtmf" method="POST">
        <Say voice="Polly.Camila" language="pt-BR">
            Para consultar seus benefÃ­cios, digite 1.
            Para verificar dinheiro esquecido, digite 2.
            Para FarmÃ¡cia Popular, digite 3.
            Para encontrar o CRAS mais prÃ³ximo, digite 4.
        </Say>
    </Gather>
</Response>
```

## Provedores Recomendados

### Comparativo Brasil

| Provedor | SMS | Voice | WhatsApp | PreÃ§o SMS | Suporte BR |
|----------|-----|-------|----------|-----------|------------|
| **Zenvia** | âœ… | âœ… | âœ… | R$ 0,06-0,15 | Excelente |
| **Twilio** | âœ… | âœ… | âœ… | R$ 0,08-0,20 | Bom |
| **Infobip** | âœ… | âœ… | âœ… | R$ 0,05-0,12 | Muito bom |
| **Movile** | âœ… | âŒ | âœ… | R$ 0,04-0,10 | Excelente |

### RecomendaÃ§Ã£o

Para o TÃ¡ na MÃ£o, recomendamos **Zenvia** ou **Infobip** por:
- Suporte nativo a nÃºmeros curtos brasileiros
- IntegraÃ§Ã£o com principais operadoras
- SDKs em Python
- Suporte tÃ©cnico em portuguÃªs
- ExperiÃªncia com governo e terceiro setor

## Formato de Mensagem Unificada

Todas as mensagens de diferentes canais sÃ£o normalizadas para um formato comum:

```python
@dataclass
class UnifiedMessage:
    """Mensagem unificada entre canais."""

    # IdentificaÃ§Ã£o
    channel: ChannelType  # whatsapp, sms, voice, web
    message_id: str
    session_id: str

    # Remetente
    user_id: str  # Telefone normalizado ou ID Ãºnico
    user_phone: Optional[str]

    # ConteÃºdo
    text: str
    media_url: Optional[str] = None
    media_type: Optional[str] = None

    # Contexto
    timestamp: datetime
    metadata: Dict[str, Any] = field(default_factory=dict)

    # Estado (para canais stateful como SMS/Voz)
    channel_state: Optional[str] = None
```

## ConfiguraÃ§Ã£o de Ambiente

### VariÃ¡veis de Ambiente (SMS/Voice)

```bash
# Provedor SMS (escolher um)
SMS_PROVIDER=zenvia  # ou twilio, infobip

# Zenvia
ZENVIA_API_TOKEN=seu_token_aqui
ZENVIA_SMS_FROM=28282

# Twilio
TWILIO_ACCOUNT_SID=ACxxxx
TWILIO_AUTH_TOKEN=seu_token
TWILIO_SMS_FROM=+5511999999999
TWILIO_VOICE_FROM=+5508001234567

# Voice/0800
VOICE_PROVIDER=twilio
VOICE_LANGUAGE=pt-BR
VOICE_VOICE=Polly.Camila

# Webhook URLs (para configurar no provedor)
WEBHOOK_BASE_URL=https://api.tanamao.gov.br
```

## MÃ©tricas e Monitoramento

### KPIs por Canal

| MÃ©trica | WhatsApp | SMS | Voz |
|---------|----------|-----|-----|
| Taxa de resposta | > 90% | > 80% | > 70% |
| Tempo mÃ©dio sessÃ£o | 3-5 min | 2-4 min | 3-6 min |
| Custo por interaÃ§Ã£o | R$ 0,05 | R$ 0,10-0,20 | R$ 0,50-1,00 |
| NPS esperado | > 70 | > 60 | > 50 |

### Alertas

- Taxa de erro > 5% em qualquer canal
- Tempo de resposta > 5s para SMS
- Chamadas abandonadas > 20%
- Custo diÃ¡rio acima do budget

## Roadmap

### Fase 1: FundaÃ§Ã£o (Atual)
- [x] WhatsApp via Twilio
- [ ] SMS bÃ¡sico (menu numÃ©rico)
- [ ] 0800 com URA simples

### Fase 2: OtimizaÃ§Ã£o
- [ ] SMS com fluxos avanÃ§ados
- [ ] Voz com NLU bÃ¡sico
- [ ] Fallback entre canais

### Fase 3: ExpansÃ£o
- [ ] Terminais em lotÃ©ricas
- [ ] Tablets em CRAS
- [ ] API para prefeituras

## ConsideraÃ§Ãµes de Acessibilidade

- **Voz**: Velocidade de fala ajustÃ¡vel, repetiÃ§Ã£o automÃ¡tica
- **SMS**: Mensagens curtas (< 160 chars quando possÃ­vel)
- **Todos**: Linguagem simples, evitar jargÃµes
- **EscalaÃ§Ã£o**: Sempre oferecer opÃ§Ã£o de atendente humano

## Integracao com MCPs

O Ta na Mao utiliza MCPs (Model Context Protocol) para integrar ferramentas externas de forma padronizada.

### MCPs Relacionados a Canais

| MCP | Uso | Status |
|-----|-----|--------|
| **Twilio MCP** | SMS, WhatsApp, Voice via MCP padronizado | Configurado |
| **Brasil API MCP** | Validacao de CEP, DDD para identificar regiao | Implementado |
| **Google Maps MCP** | Geolocalizacao e busca de locais | Implementado |

### Beneficios do Twilio MCP

- 20.6% mais rapido que integracao direta
- 19.3% menos chamadas de API
- Retry automatico em falhas
- Logging unificado

### Configuracao

Ver arquivo `.mcp.json` na raiz do projeto e documentacao em `docs/MCP_SETUP.md`.

```json
{
  "mcpServers": {
    "twilio": {
      "type": "stdio",
      "command": "npx",
      "args": ["-y", "@anthropic/mcp-twilio", "--services", "messaging,voice"]
    }
  }
}
```

### Arquitetura com MCP

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   CAMADA DE CANAIS + MCP                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ WhatsApp â”‚  â”‚   SMS    â”‚  â”‚  Voice   â”‚  â”‚   Web    â”‚    â”‚
â”‚  â”‚ Handler  â”‚  â”‚ Handler  â”‚  â”‚ Handler  â”‚  â”‚ Handler  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â”‚
â”‚       â”‚             â”‚             â”‚             â”‚          â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                            â”‚                               â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                    â”‚  MCP Manager  â”‚                       â”‚
â”‚                    â”‚  (Twilio MCP) â”‚                       â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                            â”‚                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚    Agent      â”‚
                     â”‚ Orchestrator  â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Referencias

- [Twilio SMS/Voice Brazil](https://www.twilio.com/pt-br/sms)
- [Twilio MCP Server](https://www.twilio.com/en-us/blog/introducing-twilio-alpha-mcp-server)
- [Zenvia API Documentation](https://zenvia.github.io/zenvia-openapi-spec/)
- [W3C Voice Browser Working Group](https://www.w3.org/Voice/)
- [WCAG 2.1 - Acessibilidade](https://www.w3.org/WAI/WCAG21/quickref/)
- [MCP Setup Guide](./MCP_SETUP.md)
